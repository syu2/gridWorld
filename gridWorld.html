<!DOCTYPE html>
<html>
<head>
    <link href="gridWorld.css" rel="stylesheet" type="text/css">
    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <script src="gridWorld.js"></script>
</head>

<body>
    <span id = "inputText" > Number of Rows: <input type = "text" id = "row" value = 3> 
    <span id = "inputText" > Number of Cols: <input type = "text" id = "col" value = 4> 
    <span id = "inputText" > Speed of autoPlay: <input type = "number" id = "speed" value = 100 style = "width: 50px" >
    <span id = "inputText" > Exploitation Probability: <input type = "number" id = "probability" value = 0.7 style = "width: 50px" >
    <br><br>

    <span> Start Position: <input type = "text" id = 'startRow' value = 2> <input type = "text" id = 'startCol' value = 1>
    <span> Goal: <input type = "text" id = 'goalRow' value = 0> <input type = "text" id = 'goalCol' value = 3>
    <span> Cliff: <input type = "text" id = 'cliffRow' value = 1> <input type = "text" id = 'cliffCol' value = 3>
    <span> Empty: <input type = "text" id = 'emptyRow' value = 1> <input type = "text" id = 'emptyCol' value = 1>


    <!-- <span id = "inputText" > Number of Rows: <input type = "text" id = "row" > 
    <span id = "inputText" > Number of Cols: <input type = "text" id = "col" > <br><br>

    <span> Start Position: <input type = "text" id = 'startRow'> <input type = "text" id = 'startCol'>
    <span> Goal: <input type = "text" id = 'goalRow'> <input type = "text" id = 'goalCol'>
    <span> Cliff: <input type = "text" id = 'cliffRow'> <input type = "text" id = 'cliffCol'>
    <span> Empty: <input type = "text" id = 'emptyRow'> <input type = "text" id = 'emptyCol'> -->

    <button onclick = 'setGame()' > Set Game! </button><br><br>

    <div id = "move" >
        <button id = "moveLeft" class = "arrow" style = "top: 60px" >  </button>
        <button id = "moveRight" class = "arrow" style = "transform: rotate(180deg); top: 60px; left:120px" >  </button>
        <button id = "moveUp" class = "arrow" style = "transform: rotate(90deg); left:60px" >  </button>
        <button id = "moveDown" class = "arrow" style = "transform: rotate(270deg); left:60px; top: 120px" >  </button>
    </div>
    <div class = "trials" >TRIALS: <span id = "trials" > 1 </span></div>
    <div> <button id = "auto" style = "position:absolute; left:230px; top: 200px" onclick = "auto.startPlay()" >Play For me!</button> </div>
    <div> <button id = "auto" style = "position:absolute; left:230px; top: 240px" onclick = "auto.Pause()" >Pause</button> </div>
    <br><br>


    <div id = "grid" >
        <!-- <div id = "block">
            <div id = "leftT"></div>
            <div id = "topT"></div>
            <div id = "bottomT"></div>
            <div id = "rightT"></div>
        </div> -->
    </div>
</body>

<!-- game setup -->
<script>

    function inputValues(){

        var row = Number(document.getElementById('row').value);
        var col = Number(document.getElementById('col').value);

        var inputs = {};
        inputs.goal  = {row: Number($("#goalRow").val()),  col: Number($("#goalCol").val())};
        inputs.goal.block = inputs.goal.row*col + inputs.goal.col;
        
        inputs.cliff = {row: Number($("#cliffRow").val()), col: Number($("#cliffCol").val())};
        inputs.cliff.block = inputs.cliff.row*col + inputs.cliff.col;
        
        inputs.empty = {row: Number($("#emptyRow").val()), col: Number($("#emptyCol").val())};
        inputs.empty.block = inputs.empty.row*col + inputs.empty.col;

        inputs.start = {row: Number($("#startRow").val()), col: Number($("#startCol").val())};
        inputs.start.block = inputs.start.row*col + inputs.start.col;

        return inputs;
    }

    function makeGrid(){ 

        $("#grid").empty();

        var row = Number(document.getElementById('row').value);
        var col = Number(document.getElementById('col').value);

        for (var i = 0; i < row; i++){
            for (var j = 0; j < col; j++){
                var blockNumber = col*i + j;
                var block   = "block" + blockNumber;
                var blockid = "#" + block;

                $("#grid").append( "<div id = " + block + "></div>" );
                $(blockid).css({
                    'position': 'relative',
                    'height': '160px',
                    'width': '160px',
                    'margin-top': '10px',
                    'margin-left': '10px',
                    'background-color': 'rgb(230, 230, 230)',
                    'left': 170*(blockNumber-i*col),
                    'top': -170*(blockNumber-i)
                })
                $(blockid).append('<div id = "leftT"></div>');
                $(blockid).append('<div id = "leftText"> 0 </div>');
                $(blockid).append('<div id = "topT"></div>');
                $(blockid).append('<div id = "topText"> 0 </div>');
                $(blockid).append('<div id = "rightT"></div>');
                $(blockid).append('<div id = "rightText"> 0 </div>');
                $(blockid).append('<div id = "bottomT"></div>');
                $(blockid).append('<div id = "bottomText"> 0  </div>');
            }
        }
    }

    function findRelatives(type){

        var row = Number(document.getElementById('row').value);
        var col = Number(document.getElementById('col').value);  
        // console.log( $("div#pin").parent().attr('id') )

        var rc = inputValues();

        // [row, col] of each block
        var positions = {};
        for(i = 0; i < row; i++){
            for(j = 0; j < col; j++){
                positions[i*col + j] =  [i,j];
            };
        };

        // left top right bottom block number
        var relatives = {};

        if(type === 'numbers'){
            for(var k = 0; k < row*col; k++){
                // left
                if(positions[k][1] == 0 || (positions[k][1] + positions[k][0]*col == rc.empty.block+1)){
                    relatives['block' + k] = [k];
                }else{
                    relatives['block' + k] = [k - 1];
                }
                // top
                if(positions[k][0] == 0 || (positions[k][1] + positions[k][0]*col == rc.empty.block + col)){
                    relatives['block' + k].push(k);
                }else{
                    relatives['block' + k].push(k - col);
                }
                // right
                if(positions[k][1] == col-1 || (positions[k][1] + positions[k][0]*col == rc.empty.block-1)){
                    relatives['block' + k].push(k);
                }else{
                    relatives['block' + k].push(k + 1);
                }
                // bottom
                if(positions[k][0] == row-1 || (positions[k][1] + positions[k][0]*col == rc.empty.block - col)){
                    relatives['block' + k].push(k);
                }else{
                    relatives['block' + k].push(k + col);
                }
            }
        }else if(type === 'names'){
            for(var k = 0; k < row*col; k++){
                // left
                if(positions[k][1] == 0 || (positions[k][1] + positions[k][0]*col == rc.empty.block+1)){
                    relatives['block' + k] = ['empty'];
                }else if (positions[k][1] + positions[k][0]*col == rc.goal.block+1){
                    relatives['block' + k] = ['goal'];
                }else if (positions[k][1] + positions[k][0]*col == rc.cliff.block+1){
                    relatives['block' + k] = ['cliff'];
                }else{
                    relatives['block' + k] = [k - 1];
                }
                // top
                if(positions[k][0] == 0 || (positions[k][1] + positions[k][0]*col == rc.empty.block+col)){
                    relatives['block' + k].push('empty');
                }else if(positions[k][1] + positions[k][0]*col == rc.goal.block+col){
                    relatives['block' + k].push('goal');
                }else if (positions[k][1] + positions[k][0]*col == rc.cliff.block+col){
                    relatives['block' + k].push('cliff');
                }else{
                    relatives['block' + k].push(k - col);
                }
                // right
                if(positions[k][1] == col-1 || (positions[k][1] + positions[k][0]*col == rc.empty.block-1)){
                    relatives['block' + k].push('empty');
                }else if(positions[k][1] + positions[k][0]*col == rc.goal.block-1){
                    relatives['block' + k].push('goal');
                }else if (positions[k][1] + positions[k][0]*col == rc.cliff.block-1){
                    relatives['block' + k].push('cliff');
                }else{
                    relatives['block' + k].push(k + 1);
                }
                // bottom
                if(positions[k][0] == row-1 || (positions[k][1] + positions[k][0]*col == rc.empty.block-col)){
                    relatives['block' + k].push('empty');
                }else if(positions[k][1] + positions[k][0]*col == rc.goal.block-col){
                    relatives['block' + k].push('goal');
                }else if (positions[k][1] + positions[k][0]*col == rc.cliff.block-col){
                    relatives['block' + k].push('cliff');
                }else{
                    relatives['block' + k].push(k + col);
                }
            }
        }
        return relatives;
    }

var blockRelativesNames = undefined;
var blockRelativesNumbs = undefined;
var input = undefined;

    function setGame(){

        // console.clear();

        blockRelativesNumbs = findRelatives('numbers');
        blockRelativesNames = findRelatives('names');
        input = inputValues();

        clearTimeout(auto.play);
        makeGrid();
        $("#trials").html(1);
        // console.log(JSON.stringify(findRelatives('names'), null, 2))
        var rc = inputValues();

        var row = Number(document.getElementById('row').value);
        var col = Number(document.getElementById('col').value);

        var startNumber = col*rc.start.row + rc.start.col;
        $("#block" + startNumber).css({'background-color': 'lightgrey'});
        $("#block" + startNumber).append('<div id = "pin"></div> ');

        var goalNumber = col*rc.goal.row + rc.goal.col;
        $("#block" + goalNumber).empty();
        $("#block" + goalNumber).append("<div style = 'position: absolute; height: 150px; width: 150px; top: 5px; left: 5px'> GOAL </div>")
        // $("#block" + goalNumber).children("div").css({'background-color': 'rgb(131, 197, 70)'});
        $("#block" + goalNumber).children("div").css({'background-color': 'white'});
        $("#block" + goalNumber).children("div").css({'font-size': '30px', 'color': 'rgb(230, 230, 230)', 'position':'absolute', 'align-items': 'center', 'justify-content': 'center', 'display': 'flex'});

        var cliffNumber = col*rc.cliff.row + rc.cliff.col;
        $("#block" + cliffNumber).empty();
        $("#block" + cliffNumber).append("<div style = 'position: absolute; height: 150px; width: 150px; top: 5px; left: 5px'> CLIFF</div>")
        // $("#block" + cliffNumber).css({'background-color': 'lightcoral'});
        $("#block" + cliffNumber).children("div").css({'background-color': 'white'});
        $("#block" + cliffNumber).children("div").css({'font-size': '30px', 'color': 'rgb(230, 230, 230)', 'position':'absolute', 'align-items': 'center', 'justify-content': 'center', 'display': 'flex'});

        var emptyNumber = col*rc.empty.row + rc.empty.col;
        $("#block" + emptyNumber).empty();
    }
    
</script>

<!-- learning -->
<script>

function qValue(curr, act, nextNumb, nextName){

        var alpha = 0.9;
        var gamma = 0.9;

        var maxQ = 0;

        var textIDs = ['#leftText', '#topText', '#rightText', '#bottomText'];

        textIDs.forEach(function(id){
            if(maxQ < $("#block" + nextNumb).children(id).html()*1){
                maxQ = $("#block" + nextNumb).children(id).html()*1;
            };
        });

        var R = 0;
        if(nextName === 'goal'){
            R = 0.96;
        }else if (nextName === 'cliff'){
            R = -1.04;
        }else{
            R = -0.04;
        }

        var Q = $("div#" + curr).children(act).html();
        Q = (1-alpha)*Q + alpha*(R + gamma*maxQ);
        Q = Q.toFixed(2)

        $("div#" + curr).children(act).html(Q)  
        return Q;
}

</script>

<!-- arrow button -->
<script>

    var reset = function(trials, numb){
        console.log( 'numb: ' + numb);
        $("#trials").html(trials);
        $("#block" + input.start.block).append('<div id = "pin"></div>');
        $('#block' + numb).children('div').css({"background-color": "white", "color": "rgb(230, 230, 230)"});
    }

    window.onload = function(){
        
        var previousBlock = [];
        var lastMove = [];
        var trials = 1;

        $("button.arrow").click(function(){

            console.log(blockRelativesNames);
            console.log(blockRelativesNumbs);
            console.log(input)

            var currBlock = $("div#pin").parent().attr('id');
            // console.log($(this).attr('id'));

            var nextNumb = blockRelativesNumbs[currBlock];
            var nextName = blockRelativesNames[currBlock];

            $("#pin").remove();
            if(lastMove === undefined){ 
            }else{
                $('#' + previousBlock).children(lastMove[0]).css({"background-color": "white"});
            }

            if($(this).attr('id') === 'moveLeft'){

                qValue(currBlock, '#leftText', nextNumb[0], nextName[0]);
                console.log([currBlock, '#leftText', nextNumb[0], nextName[0]])

                if(nextNumb[0] === input.goal.block || nextNumb[0] === input.cliff.block){
                    trials += 1;
                    $('#block' + nextNumb[0]).children("div").css({"background-color": "lightgreen", "color": "white"});
                    setTimeout('reset(' + trials + ',' + nextNumb[0] + ')', 100)
                    console.log('=======new trial=======');
                }else{
                    $("#block" + nextNumb[0]).append('<div id = "pin"></div>');
                    $('#' + currBlock).children('#leftT').css({"background-color": "rgb(255, 168, 153)"});
                    lastMove = ['#leftT'];
                }
            }else if($(this).attr('id') === 'moveUp'){

                qValue(currBlock, '#topText', nextNumb[1], nextName[1]);
                console.log([currBlock, '#topText', nextNumb[1], nextName[1]])

                if(nextNumb[1] === input.goal.block || nextNumb[1] === input.cliff.block){
                    trials += 1;
                    $('#block' + nextNumb[1]).children("div").css({"background-color": "lightgreen", "color": "white"})
                    setTimeout('reset(' + trials + ',' + nextNumb[1] + ')', 100)
                    console.log('=======new trial=======');
                }else{
                    $("#block" + nextNumb[1]).append('<div id = "pin"></div>');
                    $('#' + currBlock).children('#topT').css({"background-color": "rgb(255, 168, 153)"});
                    lastMove = ['#topT'];
                }
            }else if($(this).attr('id') === 'moveRight'){

                qValue(currBlock, '#rightText', nextNumb[2], nextName[2]);
                console.log([currBlock, '#rightText', nextNumb[2], nextName[2]])

                if(nextNumb[2] === input.goal.block || nextNumb[2] === input.cliff.block){
                    trials += 1;
                    $('#block' + nextNumb[2]).children("div").css({"background-color": "lightgreen", "color": "white"})
                    setTimeout('reset(' + trials + ',' + nextNumb[2] + ')', 100)
                    console.log('=======new trial=======');
                }else{
                    $("#block" + nextNumb[2]).append('<div id = "pin"></div>');
                    $('#' + currBlock).children('#rightT').css({"background-color": "rgb(255, 168, 153)"});
                    lastMove = ['#rightT'];
                }
            }else{

                qValue(currBlock, '#bottomText', nextNumb[3], nextName[3]);
                console.log([currBlock, '#bottomText', nextNumb[3], nextName[3]])

                if(nextNumb[3] === input.goal.block || nextNumb[3] === input.cliff.block){
                    trials += 1;
                    $('#block' + nextNumb[3]).children("div").css({"background-color": "lightgreen", "color": "white"})
                    setTimeout('reset(' + trials + ',' + nextNumb[3] + ')', 100)
                    console.log('=======new trial=======');
                }else{
                    $("#block" + nextNumb[3]).append('<div id = "pin"></div>');
                    $('#' + currBlock).children('#bottomT').css({"background-color": "rgb(255, 168, 153)"});
                    lastMove = ['#bottomT'];
                }
            }
            previousBlock = [currBlock];
        })
    }

</script>

<!-- automate -->
<script>

    var auto = {};

    auto.trials  = 1;
    auto.acts    = ['#left', '#top', '#right', '#bottom'];
    auto.exploit = $("#probability").val();
    
    auto.lastMove       = [];
    auto.previousBlock  = [];

    auto.startPlay = function(){
        var speed = $("#speed").val();
        auto.play = setInterval(auto.playForMe, speed);
    }

    auto.Pause = function(){
        clearTimeout(auto.play);
    }

    auto.playForMe = function(){

        // find where pin is BEFORE moving
        var currBlock = $("#pin").parent().attr("id");
        var currBlockNumb = currBlock.slice(-1)*1;

        var Qvalues = [];
        auto.acts.forEach(function(a){
            Qvalues.push($("#" + currBlock).children(a + "Text").html()*1);
        });
        var maxQvalue = Math.max(...Qvalues);

        var maxQposition = [];
        for(i=0;i<4;i++){
            if(Qvalues[i] === maxQvalue){
                maxQposition.push( i );
            };
        }
    

        // randomly choose the next act
        var p = Math.random();
        if(p >= auto.exploit){
            var randMove = Math.floor(Math.random()*4);
        }else{
            var randSelect = Math.floor(Math.random()*maxQposition.length);
            var randMove = maxQposition[randSelect];
        }
        
        var act = auto.acts[randMove];

        var nextBlockNumb = blockRelativesNumbs[currBlock][randMove];
        var nextBlockName = blockRelativesNames[currBlock][randMove];
        
        $("#pin").remove();
        if(auto.lastMove === undefined){ 
        }else{
            $('#' + auto.previousBlock).children(auto.lastMove[0]).css({"background-color": "white"});
        }

        if(nextBlockName=== 'goal' || nextBlockName === 'cliff'){
            qValue(currBlock, act + "Text", nextBlockNumb, nextBlockName);
            
            // put the pin back to start
            auto.trials += 1;
            $('#trials').html(auto.trials);
            $('#block' + nextBlockNumb).children("div").css({"background-color": "lightgreen", "color": "white"});
            setTimeout('reset('+ auto.trials + ',' + nextBlockNumb + ')', 70)
            console.log('======= trial ' + auto.trials + ' =======')
            console.log('Total Q Score: ')
        }else{
            $("#block" + nextBlockNumb).append('<div id = "pin"></div>');
            auto.lastMove = [act + 'T'];
            $('#' + currBlock).children(auto.lastMove[0]).css({"background-color": "rgb(255, 168, 153)"});

            qValue(currBlock, act + "Text", nextBlockNumb, nextBlockName);
            }

        auto.previousBlock = [currBlock];
    }

</script>


</html>